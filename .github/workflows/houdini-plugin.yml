name: Houdini Plugin Build

on:
  push:
    branches: [main, staging]
    paths:
      - 'cpp/houdini/**'
      - '.github/workflows/houdini-plugin.yml'
  pull_request:
    branches: [main]
    paths:
      - 'cpp/houdini/**'
  workflow_dispatch:

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        houdini: ['19.5', '20.0', '20.5']
        os: [ubuntu-latest, windows-latest]
        python: ['3.9', '3.10', '3.11']
        exclude:
          # Houdini 19.5 uses Python 3.9
          - houdini: '19.5'
            python: '3.10'
          - houdini: '19.5'
            python: '3.11'
          # Houdini 20.0 uses Python 3.10
          - houdini: '20.0'
            python: '3.9'
          - houdini: '20.0'
            python: '3.11'
          # Houdini 20.5 uses Python 3.11
          - houdini: '20.5'
            python: '3.9'
          - houdini: '20.5'
            python: '3.10'

    steps:
      - uses: actions/checkout@v4

      # Note: Houdini HDK requires SideFX account / license
      # This workflow assumes HDK is available or uses Docker image
      - name: Setup Houdini HDK
        uses: ./.github/actions/setup-houdini
        with:
          version: ${{ matrix.houdini }}
          client_id: ${{ secrets.SIDEFX_CLIENT_ID }}
          client_secret: ${{ secrets.SIDEFX_CLIENT_SECRET }}
        continue-on-error: true

      - name: Setup CMake
        uses: lukka/get-cmake@latest

      - name: Configure
        run: |
          cmake -B build -S cpp/houdini \
            -DCMAKE_BUILD_TYPE=Release \
            -DHOUDINI_VERSION=${{ matrix.houdini }}
        continue-on-error: true

      - name: Build
        run: cmake --build build --config Release --parallel
        continue-on-error: true

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: houdini-${{ matrix.houdini }}-${{ runner.os }}
          path: |
            build/**/*.so
            build/**/*.dll
            build/**/*.dylib
          if-no-files-found: ignore
